<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.9/dist/css/bootstrap-select.min.css">
  
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.9/dist/js/bootstrap-select.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/3.2.1/math.min.js"></script>
  <script src= "https://d3js.org/d3.v4.min.js"></script>  
  <script src= "https://d3js.org/d3-color.v1.min.js"></script>  
  <script src= "https://d3js.org/d3-interpolate.v1.min.js"></script>  
  <script src= "https://d3js.org/d3-scale-chromatic.v1.min.js"></script>  
  <link rel="stylesheet" href="style.css" type="text/css" />

<script>

function roundToTwo(num) {    
    return +(Math.round(num + "e+1")  + "e-1");
}

//--------------- DEFINE FUNCTION CREATING THE PLOTS ------------

// LOAD THE DATA
Plotly.d3.csv("https://raw.githubusercontent.com/cieb-unibas/inventor_ethnicity/main/report/plot3_df.csv", function(err, rows){
function unpack(rows, key) {
        return rows.map(function(row) { return row[key]; });
    }

// DEFINE VARIABLES FOR PLOTTING
  var p_year = unpack(rows, 'p_year'), 
      country = unpack(rows, 'country'),
      tech_group = unpack(rows, 'tech_group'),
      share = unpack(rows, 'share'),
      list_of_countries = []; // all possible countries to display

// DEFINE THE LIST OF COUNTRIES THAT CAN BE DISPLAYED
  for (var i = 0; i < country.length; i++ ){
      // check if an entry is not included in the 'list_of_countries'
      if (list_of_countries.indexOf(country[i]) === -1 ){
        // if so, append it to the list
        list_of_countries.push(country[i]);
      }
    }
    
// EXTRACT THE DATA FOR THE CHOSEN COUNTRIES
  function getCountryData(chosen_country, chosen_tech_group) {
        current_years = []; // year information to display for the current selection
        current_share = []; // shares information to display for the current selection
        current_country = []; // country information to display for the current selection
        text_var = [];
        for (var i = 0 ; i < country.length ; i++){
          for(var j = 0; j < country.length; j ++){
            for(var k = 0; k < country.length; k ++){
              if (country[i] === chosen_country[j] && tech_group[i] === chosen_tech_group[k]) {
                current_share.push(share[i]);
                current_country.push(country[i]);
                current_years.push(p_year[i]);
                text_var.push('Country: ' + country[i] + '<br>' +  
                          'Year: ' + p_year[i] + '<br>' +
                          'Share: ' + roundToTwo(share[i]*100) + '%');
                
              }
            }
          }
        }
   };
   
// DEFAULT SELECTIONS FOR THE PLOT
  setBubblePlot(["CH", "DE", "US", "GB"], ["mrna_pharma_i"]);
   
// DEFINE THE PLOT FOR THE SELECTED TECH_GROUP AND COUNTRIES
  function setBubblePlot(chosen_country, chosen_tech_group) {
        getCountryData(chosen_country, chosen_tech_group);

        var trace1 = {
            y: current_share,
            x: current_years,
            customdata: text_var,
            type: 'scatter',
            mode: 'lines+markers',
            hovertemplate:  '%{customdata}' + '<extra></extra>',
            transforms: [{type: 'groupby', 
                          groups: current_country,
                          styles: [
                          {target: 'CH', value: {marker: {color: d3.interpolateViridis(0.71)}}},
                          {target: 'CA', value: {marker: {color: d3.interpolateViridis(0)}}},
                          {target: 'US', value: {marker: {color: d3.interpolateViridis(0.09)}}},
                          {target: 'FR', value: {marker: {color: d3.interpolateViridis(0.18)}}},      
                          {target: 'ES', value: {marker: {color: d3.interpolateViridis(0.27)}}},
                          {target: 'DE', value: {marker: {color: d3.interpolateViridis(0.36)}}},
                          {target: 'GB', value: {marker: {color: d3.interpolateViridis(0.45)}}},
                          {target: 'SE', value: {marker: {color: d3.interpolateViridis(0.54)}}},
                          {target: 'NL', value: {marker: {color: d3.interpolateViridis(0.63)}}},      
                          {target: 'AT', value: {marker: {color: d3.interpolateViridis(0.80)}}},      
                          {target: 'DK', value: {marker: {color: d3.interpolateViridis(0.89)}}},      
                          {target: 'IT', value: {marker: {color: d3.interpolateViridis(1)}}}
                          ]
            }], 
        };
        
        var data = [trace1];
        
        var layout = {
          scrollZoom: false,
          autosize: true,
      //  width: 800,
      //  height: 500,
          hovermode: "closest",
          margin: {
            l: 100,
            r: 10,
            b: 100,
            t: 20
          },
          xaxis: {
            fixedrange: true,
            range: [1984.75, 2015.15],
            title: '<b>Year</b>',
            zeroline: false,
            showaxis: true,
            showline: false,
            ticks: 'outside',
            showgrid: false
          },
          yaxis: {
            fixedrange: true,
            title: '<b>Prevalence of Inventors with Non-Western Ethnic Origins</b>',
            showline: false,
            zeroline: false,
            tickformat: '.1%', 
            showgrid: false,
            ticks: 'outside'
          }
        };
        
        Plotly.newPlot('myDiv', data, layout, {displayModeBar: false});
   };
   
   // DEFINE FROM WHERE TO GET THE USER'S CHOICES
   var countrySelector = document.getElementById("select_1");
   var chosen_tech_group = document.getElementById("select_2");
   
   // DEFINE FUNCTION TO UPDATE THE PLOT BASED ON THE USERS CHOICE
   function updateCountry(){
     var var_2l = [];
     var var_1l = [];
     
     // get the user's selected countries and store it in the variable "var2l"
     $.each($("#select_1 option:selected" ), function() {
       var_2l.push($(this).val());
     })
     
     // get the user's selected tech_group and store it in the variable "var1l"
     $.each($("#select_2 option:selected" ), function() {
       var_1l.push($(this).val());
     })
     
     // upate the plot with the new variables
     setBubblePlot(var_2l, var_1l);
   }
   
   // UPDATE THE PLOT IF THE USER CHANGES HIS/HER SELECTION
   countrySelector.addEventListener('change', updateCountry, false);
   chosen_tech_group.addEventListener('change', updateCountry, false);
});

</script>
</head>

<!-- DEFINE WHAT IS DISPLAYED ON THE WEBPAGE -->
<body>
<div class="showcase__section" id="bubble">
  <div id="bubbleplots">
    <div class="plot" id="plotdiv"></div>
    <div class="control-row">
      <select class="selectpicker" id="select_1" name="select1" multiple="multiple" data-actions-box="true">
        <option value="CH" selected>Switzerland</option>
        <option value="US" selected>USA</option>
        <option value="DE" selected>Germany</option>
        <option value="FR" selected>France</option>
        <option value="CA">Canada</option>  
        <option value="GB">Great Britain</option>
        <option value="IT">Italy</option>
        <option value="ES">Spain</option>
        <option value="SE">Sweden</option>
        <option value="DK">Denmark</option>
        <option value="NL">Netherlands</option>
        <option value="AT">Austria</option>  
        </select>
    </div>
  </div>
</div>

<div class="showcase__section" id="bubble">
  <div id="bubbleplots">
      <div class="plot" id="plotdiv"></div>
      <div class="control-row">
        <select class="selectpicker" id="select_2" name="select2" data-actions-box="true">
          <option value="Chemistry & Materials">Chemistry & Materials</option>  
          <option value="Computer Technology" selected>Computer Technology</option>
          <option value="Consumer Goods & Civil Engineering">Consumer Goods & Civil Engineering</option>  
          <option value="Electrical & Audiovisual Technologies">Electrical & Audiovisual Technologies</option>
          <option value="Electrical Machinery">Electrical Machinery</option>
          <option value="Engines, Turbines, Thermal & Environmental Technologies">Engines, Turbines, Thermal & Environmental Technologies</option>
          <option value="Information & Communication Technology">Information & Communication Technology</option>
          <option value="Instruments">Instruments</option>
          <option value="Machines & Mechanical Engineering">Machines & Mechanical Engineering</option>
          <option value="Medical Technology">Medical Technology</option>
          <option value="Pharmaceuticals & Biotechnology">Pharmaceuticals & Biotechnology</option>
          <option value="Transport">Transport</option>
          <option value="Semiconductors">Semiconductors</option>
        </select>
    </div>
  </div>
</div>

<div id='myDiv'></div>

</body>
    
